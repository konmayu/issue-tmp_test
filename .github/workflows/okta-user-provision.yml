---
name: Provision Okta User from Issue

'on':
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write

jobs:
  provision-okta-user:
    if: contains(github.event.issue.labels.*.name, 'okta-user-request')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Parse issue body
        id: parse
        run: |
          echo "${{ github.event.issue.body }}" > issue_body.txt

          get_value() {
            awk -v key="$1" '
              $0 ~ key {
                found=1
                next
              }
              found {
                while ($0 ~ /^[:space:]*$/) {getline}
                print
                exit
              }
            ' issue_body.txt | xargs
          }

          FIRST_NAME=$(get_value "ÂêçÔºàFirst NameÔºâ")
          LAST_NAME=$(get_value "ÂßìÔºàLast NameÔºâ")
          EMAIL=$(get_value "„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ")
          REVIEWER=$(get_value "„É¨„Éì„É•„ÉØ„Éº")

          echo "FIRST_NAME=$FIRST_NAME" >> $GITHUB_ENV
          echo "LAST_NAME=$LAST_NAME" >> $GITHUB_ENV
          echo "EMAIL=$EMAIL" >> $GITHUB_ENV
          echo "REVIEWER=$REVIEWER" >> $GITHUB_ENV

            FILENAME=$(echo "$EMAIL" \
              | sed 's/@/-at-/g' \
              | sed 's/[^a-zA-Z0-9._-]//g')
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            FILENAME="${FILENAME}-${TIMESTAMP}"
            echo "FILENAME=$FILENAME" >> $GITHUB_ENV

      - name: Create JSON file
        run: |
          mkdir -p user-json
          cat <<EOF > user-json/${FILENAME}.json
          {
            "schemas": ["urn:ietf:params:scim:schemas:core:2.0:User"],
            "userName": "$EMAIL",
            "name": {
              "givenName": "$FIRST_NAME",
              "familyName": "$LAST_NAME"
            },
            "displayName": "$FIRST_NAME $LAST_NAME",
            "emails": [{
              "primary": true,
              "value": "$EMAIL",
              "type": "work"
            }],
            "locale": "ja-JP",
            "externalId": "$EMAIL",
            "active": true
          }
          EOF

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Add user JSON for ${{ env.EMAIL }}"
          branch: user-json-${{ github.run_id }}
          title: "Provision request for ${{ env.EMAIL }}"
          body: |
            üéØ Okta„É¶„Éº„Ç∂„Éº‰ΩúÊàê„ÅÆPR„Åß„Åô„ÄÇ
            ÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„ÄÅ„É¨„Éì„É•„ÉØ„Éº„ÅØ ${{ env.REVIEWER }} „Åß„Åô„ÄÇ
          add-paths: user-json/${{ env.FILENAME }}.json
          reviewers: ${{ env.REVIEWER }}
          token: ${{ secrets.GITHUB_TOKEN }}
