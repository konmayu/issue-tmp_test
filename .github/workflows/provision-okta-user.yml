name: Generate User JSON

on:
  issues:
    types: [opened]

permissions:
  contents: write  # ✅ GITHUB_TOKEN に push 権限を与える

jobs:
  generate-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Parse issue content
        run: |
          echo "${{ github.event.issue.body }}" > issue_body.txt

          # 共通抽出関数
          get_value() {
            awk -v key="$1" '
              $0 ~ key {
                found=1
                next
              }
              found {
                # 空行を飛ばす
                while ($0 ~ /^[:space:]*$/) {getline}
                print
                exit
              }
            ' issue_body.txt | xargs
          }

          FIRST_NAME=$(get_value "名（First Name）")
          LAST_NAME=$(get_value "姓（Last Name）")
          EMAIL=$(get_value "メールアドレス")
          DISPLAY_NAME=$(get_value "表示名")
          LOCALE=$(get_value "ロケール")
          EXTERNAL_ID=$(get_value "外部ID")

          if [ -z "$EMAIL" ]; then
            echo "❌ メールアドレスが空です。Issue本文の形式を確認してください。"
            cat issue_body.txt
            exit 1
          fi

          echo "抽出結果:"
          echo "FIRST_NAME=$FIRST_NAME"
          echo "LAST_NAME=$LAST_NAME"
          echo "EMAIL=$EMAIL"
          echo "DISPLAY_NAME=$DISPLAY_NAME"
          echo "LOCALE=$LOCALE"
          echo "EXTERNAL_ID=$EXTERNAL_ID"

          echo "FIRST_NAME=$FIRST_NAME" >> $GITHUB_ENV
          echo "LAST_NAME=$LAST_NAME" >> $GITHUB_ENV
          echo "EMAIL=$EMAIL" >> $GITHUB_ENV
          echo "DISPLAY_NAME=$DISPLAY_NAME" >> $GITHUB_ENV
          echo "LOCALE=$LOCALE" >> $GITHUB_ENV
          echo "EXTERNAL_ID=$EXTERNAL_ID" >> $GITHUB_ENV

      - name: Create JSON file
        run: |
          mkdir -p public/users

          FILENAME=$(echo "$EMAIL" | sed 's/@/-at-/g' | sed 's/[^a-zA-Z0-9._-]//g')
          JSON_PATH="public/users/${FILENAME}.json"

          cat <<EOF > "$JSON_PATH"
          {
            "schemas": ["urn:ietf:params:scim:schemas:core:2.0:User"],
            "userName": "$EMAIL",
            "name": {
              "givenName": "$FIRST_NAME",
              "familyName": "$LAST_NAME"
            },
            "displayName": "$DISPLAY_NAME",
            "emails": [{
              "primary": true,
              "value": "$EMAIL",
              "type": "work"
            }],
            "locale": "$LOCALE",
            "externalId": "$EXTERNAL_ID",
            "active": true
          }
          EOF

          echo "JSON_PATH=$JSON_PATH" >> $GITHUB_ENV

      - name: Commit & Push JSON
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git add "$JSON_PATH"
          git commit -m "Add user JSON for $EMAIL"
          git push origin HEAD
